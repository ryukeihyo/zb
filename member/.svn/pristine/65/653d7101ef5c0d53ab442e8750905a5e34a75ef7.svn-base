/* 
 * 会员中心总帐统计模块
 * 泽百通科技有限公司
 * banu@163.com
 */

// ------------- 消费记录页 ------------
// ====================================
var jilu_type;  //消费记录页各子列表名
var money_type; //充值及余额页各子列表名
var call_ajax_url;
var call_ajax_url_base = call_ajax_url;
var page_num = 1;
var start_date = "";
var end_date = "";
//行政级别
var area_id = 0;
var area_type = "quan";
//级别下级分支
var branch_area_id;
var branch_area_type;
var page_stat_tag = Array();
var ins_html_tr;
var data;
// 行政分区级别
var area_rank = Array();
area_rank["quan"] = 0;
area_rank["province"] = 1;
area_rank["city"] = 2;
area_rank["county"] = 3;
area_rank["salesman"] = 4;
area_rank["business"] = 5;
area_rank["consumer"] = 6;

var area_tag = Array();
area_tag[0] = "quan";
area_tag[1] = "province";
area_tag[2] = "city";
area_tag[3] = "county";
area_tag[4] = "salesman";
area_tag[5] = "business";
area_tag[6] = "consumer";

// 行政分区级别名称
var area_rank_name = Array();
area_rank_name["quan"] = "总公司";
area_rank_name["province"] = "分公司";
area_rank_name["city"] = "代理商";
area_rank_name["county"] = "事业部";
area_rank_name["salesman"] = "业务员";
area_rank_name["business"] = "商家";
area_rank_name["consumer"] = "消费会员";


function area_son_type_name(an_i, at_j) {
    area_type_veiw = an_i;
    area_type_text = area_rank_name[area_type_veiw];
    at_i = area_rank[area_type_veiw];
    //at_j = at_i + 1;
    at_j = at_i + at_j;
    at_k = area_tag[at_j];
    return  area_rank_name[at_k];
}


/* 模拟弹窗提示 */
$(document).ajaxStart(function () {
    //$("#counter").text("");
    $("#pop_box").show();
});
$(document).ajaxStop(function () {
    $("#pop_box").hide();
});


$(function () {
// 初次获取Ajax路径
    if (call_ajax_url == undefined) {
        call_ajax_url = $("#call_ajax_url a").attr("href");
        console.log("初次获取AJAX地址：" + call_ajax_url);
    }

    //获得当前标签信息
    $("#xaiofei_button_list>li").click(function () {
        $(this).addClass("current").siblings().removeClass("current");
        jilu_type = $(this).children().attr("rel");
        //判断当前标签的页号
        if (!page_stat_tag[jilu_type]) {
            page_stat_tag[jilu_type] = 1;
            page_num = 1;
//            call_ajax_url = call_ajax_url_base;
        } else {
            page_num = page_stat_tag[jilu_type];
        }
        console.log(jilu_type + ":" + page_stat_tag[jilu_type]);
        jilu_list_pub();
        return false;
    });

    $(".page_list_box").on("click", "a", function () {
        console.log("翻页：" + $(this).text());
        page_num = $(this).text();
        page_cur_num = $(".page_list_box li.current a").text();
        if (page_num == "下一页") {

            page_num = parseInt(page_cur_num) + 1;
        }
        if (page_num == "上一页") {
            page_num = parseInt(page_cur_num) - 1;
        }
        page_stat_tag[jilu_type] = page_num;
        page_stat_tag[money_type] = page_num;
//        call_ajax_url = $(this).attr("href");
        console.log(page_num);
        console.log("加载URL：" + call_ajax_url);
        //刷新主数据区
        reCallMainData();
        return false;
    });

    function jilu_list_pub() {
        console.log(jilu_type);
        jilu_ajax_url = call_ajax_url + "?p=" + page_num;
        $.ajax({
            url: jilu_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                jilu_type: jilu_type,
                area_id: area_id,
                area_type: area_type,
                start_date: start_date,
                end_date: end_date
            },
            success: function (data, testStatus) {
                //alert(data);
                $("#xiaofei_table_list tbody").html("");
                i = 0;
                while (data[i]) {
                    //alert(data[i].uid);
                    ins_html_tr = "<tr><td>"
                            + data[i].uid + "</td><td>"
                            + data[i].platform + "</td><td>"
                            + data[i].fmoney + "</td><td>"
                            + moment(parseInt(data[i].addtime), "X").format("YYYY-MM-DD HH:mm:ss") + "</td><td>"
                            + data[i].realname + "</td><td>"
                            + showNull(data[i].beizhu) + "</td></tr>";
                    $("#xiaofei_table_list tbody").append(ins_html_tr);
                    i++;
                }
                if (data.page_show == undefined)
                {
                    ins_html_page = "";
                } else {
                    ins_html_page = data.page_show;
                }
//                console.log("页码:" + ins_html_page);
                $(".page_list_box ul").html(ins_html_page);
            },
            error: function () {
                alert("文章列表加载失败");
            },
            dataType: "json"
        });
    }


    /*   -----------------------------  充值及余额  -----------------------------
     * ====================================================================    */
// 标签内容页切换
    var index_i;
    $(".multipage_menu li").click(function () {
        $(this).addClass("current").siblings().removeClass("current");
        index_i = $(".multipage_menu li").index(this);
        $(".multipage_body > li").eq(index_i).show().siblings().hide();

        $(this).addClass("current").siblings().removeClass("current");
        money_type = $(this).children().attr("rel");

        if (!page_stat_tag[money_type]) {
            page_stat_tag[money_type] = 1;
            page_num = 1;
//            call_ajax_url = call_ajax_url_base;
        } else {
            page_num = page_stat_tag[money_type];
        }
        console.log(money_type + ":" + page_stat_tag[money_type]);

        chongzhi_list_pub();
        return false;
    });
    // $(".multipage_menu li").eq(0).click();


    function chongzhi_list_pub() {
        console.log(area_type);
        chongzhi_ajax_url = call_ajax_url + "?p=" + page_num;
        $.ajax({
            url: chongzhi_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                money_type: money_type,
                area_id: area_id,
                area_type: area_type,
                start_date: start_date,
                end_date: end_date
            },
            success: function (data, testStatus) {
                //alert(data);
                $("#chongzhi_table_list tbody").eq(index_i).html("");

                i = 0;
                while (data[i]) {
                    //alert(data[i].uid);
                    if (money_type == "jifen_total") {
                        ins_html_tr = "<tr><td>"
                                + data[i].id + "</td><td>"
                                + data[i].platform + "</td><td>"
                                + data[i].money + "</td></tr>";
                    } else if (money_type == "jifen_yue") {
                        ins_html_tr = "<tr><td>"
                                + data[i].id + "</td><td>"
                                + data[i].platform + "</td><td>"
                                + data[i].score + "</td></tr>";
                    } else if (money_type == "zebaib_total") {
                        ;
                    } else if (money_type == "zebaib_yue") {
                        ins_html_tr = "<tr><td>"
                                + data[i].id + "</td><td>"
                                + data[i].mobile + "</td><td>"
                                + data[i].username + "</td><td>"
                                + data[i].realname + "</td><td>"
                                + data[i].zebaib + "</td></tr>";
                    } else if (money_type == "yucun_total") {
                        ;
                    } else if (money_type == "yucun_yue") {
                        ;
                    }

                    $("#chongzhi_table_list tbody").eq(index_i).append(ins_html_tr);
                    i++;
                }

                if (data.page_show == undefined)
                {
                    ins_html_page = "";
                } else {
                    ins_html_page = data.page_show;
                }
                $(".page_list_box ul").eq(index_i).html(ins_html_page);
            },
            error: function () {
                alert("加载失败");
            },
            dataType: "json"
        });
    }


//加载主页面后自动执行的动作
    //$("#xaiofei_button_list>li").eq(0).click();
    $("#load_start_click").click();

    /* 刷新主数据区操作 */
    function reCallMainData() {
        if ($("#xiaofei_table_list").length > 0) {
            jilu_list_pub();
        }
        if ($("#chongzhi_table_list").length > 0) {
            chongzhi_list_pub();
        }
        if ($("#son_branch_list").length > 0) {
            branch_list();
        }
    }

    /* ---------------------      会员数量       -------------------------------
     * ======================================================================= */

    if ($("#son_branch_total").length > 0) {
        //进入页面启动统计查询
        branch_total();
        //启动当前登陆会员级别下一级的列表
        ;
    }
    function branch_total() {
        $.ajax({
            url: call_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                operation_type: "statistical",
                area_id: area_id,
                area_type: area_type
            },
            success: function (data, testStatus) {
                $("#quan_membership  > td:nth-child(2)").html(data["fengongsi_count"]);
                $("#province_membership  > td:nth-child(2)").html(data["daili_count"]);
                $("#city_membership  > td:nth-child(2)").html(data["shiye_count"]);
                $("#county_membership  > td:nth-child(2)").html(data["yewu_count"]);
                $("#salesman_membership  > td:nth-child(2)").html(data["shangjia_count"]);
                $("#business_membership  > td:nth-child(2)").html(data["huiyuan_count"]);
                // 加载主页面时的动作
                // $("#son_branch_total td>a").eq(0).click();
                branch_area_id = area_id;
                branch_area_type = area_type;
                //alert(branch_area_id+" and "+branch_area_type);
                branch_list();

            },
            error: function () {
                alert("加载失败");
            },
            dataType: "json"
        });
    }

    $("#son_branch_total a").click(function () {
        branch_area_type = $(this).parent().parent().attr("id").replace("_membership", "");
        console.log("查看：" + area_type);
        branch_area_id = area_id;
        branch_list();
        return false;
    });

    function branch_list() {
        //在表行“数量”显示当前下一级别名称
        astn = area_son_type_name(branch_area_type, 2);
        if (astn != undefined) {
            $("#son_branch_list th:nth-child(3)").text(astn + "数量");
        } else {
            $("#son_branch_list th:nth-child(3)").text("");
        }
        //
        branch_ajax_url = call_ajax_url + "?p=" + page_num;
        console.log("test:" + call_ajax_url);
        $.ajax({
            url: branch_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                operation_type: "view_details",
                area_id: branch_area_id,
                area_type: branch_area_type
            },
            success: function (data, testStatus) {
                $("#son_branch_list tbody").html("");
                i = 0;
                while (data[i]) {
                    ins_html_tr = "<tr><td>"
                            + data[i].id + "</td><td>"
                            + data[i].jigou_name + "</td><td>"
                            + data[i].data_count
                            + "</td><td>";
                    //查看下一级链接，如无值则显示空
                    area_type_veiw = data[i].area_type;
                    view_son_text = area_son_type_name(area_type_veiw, 1);
                    if (view_son_text != undefined) {
                        ins_html_tr += "<a rel=\"" + area_type_veiw + "\">查看"
                                + view_son_text
                                + "</a>";
                    }
                    ins_html_tr += "</td></tr>";
                    $("#son_branch_list tbody").append(ins_html_tr);
                    i++;
                }
                if (data.page_show == undefined)
                {
                    ins_html_page = "";
                } else {
                    ins_html_page = data.page_show;
                }
//                console.log("页码:" + ins_html_page);
                $(".page_list_box ul").html(ins_html_page);
            },
            error: function () {
                alert("加载失败");
            },
            dataType: "json"
        });
    }

// 查看下一级机构
    $("#son_branch_list tbody").on("click", "a", function () {
        branch_area_id = $(this).parents("tr").children("td").eq(0).text();
        branch_area_type = $(this).attr("rel");
        page_num = 1;
        branch_list();
        return false;
    });


    /* ---------------------      收入统计      -------------------------------
     * ======================================================================= */
    //进入主页面先显示收入统计历史
    var income_to_day;
    if ($("#income_history_list").length > 0) {
        income_to_day = moment().format("YYYY-MM-DD HH:mm:ss");
        $("#accounting_end_date").val(income_to_day);
        income_history();
    }
    function income_history() {
        //alert("income_history_list");
        history_ajax_url = call_ajax_url + "?p=" + page_num;
        $.ajax({
            url: history_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                operation_type: "jiesuan_history",
                area_id: area_id,
                area_type: area_type
            },
            success: function (data, testStatus) {
                $("#income_history_list tbody").html("");
                i = 0;
                while (data[i]) {
                    //alert(data[i].uid);
                    ins_html_tr = "<tr><td>"
                            + data[i].id + "</td><td>"
                            + data[i].start_date + "</td><td>"
                            + data[i].end_date + "</td><td>"
                            + "" + "</td><td>"
                            + "<a>查看</a>" + "</td></tr>";
                    $("#income_history_list tbody").append(ins_html_tr);
                    i++;
                }
                //结算开始时间
                income_end_date = data.end_date;
                $("#accounting_start_date").val(income_end_date);

                if (data.page_show == undefined)
                {
                    ins_html_page = "";
                } else {
                    ins_html_page = data.page_show;
                }
//                console.log("页码:" + ins_html_page);
                $(".page_list_box ul").html(ins_html_page);
            },
            error: function () {
                alert("加载失败");
            },
            dataType: "json"
        });
    }
    //添加点击“查看详细信息”行为
    var jiesuan_id;
    $("#income_history_list tbody").on("click", "a", function () {
        jiesuan_id = $(this).parents("tr").children("td").eq(0).text();
        branch_area_id = area_id;
        branch_area_type = area_type;
        $("#income_son_list").show();
        income_son_list();
    });
//查看收入详细信息
    function income_son_list() {
        $.ajax({
            url: history_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                operation_type: "view_details",
                area_id: branch_area_id,
                area_type: branch_area_type,
                jiesuan_id: jiesuan_id
            },
            success: function (data, testStatus) {
                $("#income_son_list tbody").html("");
                i = 0;
                while (data[i]) {
                    //alert(data[i].area_type);
                    //查看下一级链接，如无值则显示空
                    area_type_veiw = data[i].area_type;
                    view_son_text = area_son_type_name(area_type_veiw, 1);
                    ins_html_tr = "<tr><td>"
                            + data[i].id + "</td><td>"
                            + data[i].jisuan_name
                            // + " ( " + area_type_text + " ) "
                            + "</td><td>"
                            + data[i].money_total + "</td><td>"
                            + data[i].guanlifei_tatol + "</td><td>"
                            + data[i].jiesuan_bili + "</td><td>"
                            + data[i].jisuan_ticheng + "</td><td>";
                    if (view_son_text != undefined) {
                        ins_html_tr += "<a rel=\"" + area_type_veiw + "\">查看"
                                + view_son_text
                                + "</a>";
                    }
                    ins_html_tr += "</td></tr>";
                    $("#income_son_list tbody").append(ins_html_tr);
                    i++;
                }

                if (data.page_show == undefined)
                {
                    ins_html_page = "";
                } else {
                    ins_html_page = data.page_show;
                }
//                console.log("页码:" + ins_html_page);
                $(".page_list_box ul").html(ins_html_page);
            },
            error: function () {
                alert("加载失败");
            },
            dataType: "json"
        });
    }

// 查看下一级机构
    $("#income_son_list tbody").on("click", "a", function () {
        branch_area_id = $(this).parents("tr").children("td").eq(0).text();
        branch_area_type = $(this).attr("rel");
        income_son_list();
        return false;
    });

//结算提交确认
    var accounting_start_date;
    var accounting_end_date;
    $("#button_income").click(function () {
        accounting_start_date = $("#accounting_start_date").val();
        accounting_end_date = $("#accounting_end_date").val();
        confirm_txt = "开始时间：" + accounting_start_date + "<br>\n结束时间：" + accounting_end_date;
        $("#confirm_box p").html(confirm_txt);
        $("#confirm_box").show();
    });
    $("#confirm_yes").click(function () {
        $("#confirm_box").hide();

        $.ajax({
            url: call_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                operation_type: "jiesuan",
                accounting_start_date: accounting_start_date,
                accounting_end_date: accounting_end_date
            },
            success: function (data, testStatus) {
                if (data == "false") {
                    alert("未操作");
                }
                if (data == "true") {
                    alert("操作成功");
                    income_history();
                    income_to_day = moment().format("YYYY-MM-DD HH:mm:ss");
                    $("#accounting_end_date").val(income_to_day);
                }

            },
            error: function () {
                alert("加载失败");
            },
            dataType: "text"
        });


    });
    $("#confirm_no").click(function () {
        $("#confirm_box").hide();
    });


    /* -------------------------------- 省市县菜单联动  -------------------------
     * =========================================================================
     * 
     *   提交给服务器的地区行政等级用name属性
     *   操作的id属性比name多一个后缀“_id”，以避免id命名冲突
     *   */
    var area_ajax_url;
    var son_area_type = "province";
    var area_select_box = "#" + son_area_type + "_id";
    area_ajax_url = $("#area_ajax_url").attr("href");

    $("#regionalism_select_box select").change(function () {
        area_id = $(this).children('option:selected').val();
        area_type = $(this).attr("name");
        son_area_type = $(this).next().attr("name");
        // 清空下级地区原选项
        // 特殊地区设置，如全国、直辖市
        // 全国：默认为0
        if (area_id == 0) {
            son_area_type = area_type;
            area_type = "quan";
        }
        area_select_box = "#" + son_area_type + "_id";
        console.log(area_id + "," + son_area_type);
        area_list_pub();
        //刷新数据区数据
        reCallMainData();

    });

    area_list_pub();

    function area_list_pub() {
        // 先清空原选项，再插入一个空选项
        cur_area_id = "#" + area_type + "_id";
        if (area_type == "quan") {
            cur_area_id = "#province_id";
        }
        $(cur_area_id).nextAll().each(function () {
            $(this).html("");
            console.log("已清空：" + $(this).attr("name"));
        });
        $(cur_area_id).next().html("<option value=\"\">⬇</option>");
        $.ajax({
            url: area_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                area_id: area_id,
                area_type: area_type
            },
            success: function (data, testStatus) {
                //alert(data[1].id);
                i = 0;
                while (data[i]) {
                    //alert(data[i].uid);
                    ins_html_op = "<option value=\""
                            + data[i].id + "\">"
                            + data[i].realname + "</option>\n";
                    $(area_select_box).append(ins_html_op);
                    i++;
//                    console.log(ins_html_op);
                }
            },
            error: function () {
                alert("地区列表加载失败");
            },
            dataType: "json"
        });

    }



    /* --------------------------------------------
     *               时间设置与运算               */
    $("#button_day").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date).change();
        start_date = moment().subtract(1, "days").format("YYYY-MM-DD");
        $("#start_date").val(start_date).change();
    });
//    $("#button_day").click();
    $("#button_week").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date).change();
        start_date = moment().subtract(7, "days").format("YYYY-MM-DD");
        $("#start_date").val(start_date).change();
    });
    $("#button_month").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date).change();
        start_date = moment().subtract(1, "months").format("YYYY-MM-DD");
        $("#start_date").val(start_date).change();
    });
    $("#button_trimester").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date).change();
        start_date = moment().subtract(3, "months").format("YYYY-MM-DD");
        $("#start_date").val(start_date).change();
    });
    $("#button_halfyear").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date).change();
        start_date = moment().subtract(6, "months").format("YYYY-MM-DD");
        $("#start_date").val(start_date).change();
    });
    $("#button_year").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date).change();
        start_date = moment().subtract(1, "years").format("YYYY-MM-DD");
        $("#start_date").val(start_date).change();
    });




    //    时间动作   DATE
    // ------------------------------------------------------------------
    var reg_date_chk = /^\d{4}(-\d{2}){2}(\s?\d{2}(:\d{2}){0,2})?$/;
//验证时间格式
    $("#start_date").change(function () {
        start_date = $(this).val();
        if (reg_date_chk.test(start_date)) {
            console.log("开始时间格式正确");
            reCallMainData();
        } else {
            alert("请输入正确的时间格式");
            $(this).val(start_date);
        }

    });

    $("#end_date").change(function () {
        end_date = $(this).val();
        if (reg_date_chk.test(end_date)) {
            console.log("结束时间格式正确");
            reCallMainData();
        } else {
            alert("请输入正确的时间格式");
            $(this).val(end_date);
        }
    });




});



/* -------------------------------------------------------------------- 
 * 浏览器不支持DATE类型调用相关插件
 * */

var vi = document.createElement('input');
vi.setAttribute('type', 'date');
//浏览器不支持date类型
if (vi.type == 'text') {
    console.log("浏览器不支持DATE输入控件");

}



/* ---------------------------------------------------------
 *               一些值的处理函数               */
function showNull(bl) {
    if (bl == undefined) {
        return "";
    }
}