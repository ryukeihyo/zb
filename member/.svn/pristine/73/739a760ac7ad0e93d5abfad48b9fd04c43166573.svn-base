/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

// ------------- 消费记录页 ------------
// ====================================
var jilu_type;  //消费记录页各子列表名
var call_ajax_url;
var call_ajax_url_base = call_ajax_url;
var page_num = 1;
var area_id = 0;
var area_type = "quan";
var page_stat_tag = Array();


/* 模拟弹窗提示 */
$(document).ajaxStart(function () {
    //$("#counter").text("");
    $("#pop_box").show();
});
$(document).ajaxStop(function () {
    $("#pop_box").hide();
});


$(function () {
// 初次获取Ajax路径
    if (!call_ajax_url) {
        call_ajax_url = $("#call_ajax_url a").attr("href");
        console.log(call_ajax_url);
    }

    //获得当前标签信息
    $("#xaiofei_button_list>li").click(function () {
        $(this).addClass("current").siblings().removeClass("current");
        jilu_type = $(this).children().attr("rel");
        //判断当前标签的页号
        if (!page_stat_tag[jilu_type]) {
            page_stat_tag[jilu_type] = 1;
            page_num = 1;
//            call_ajax_url = call_ajax_url_base;
        } else {
            page_num = page_stat_tag[jilu_type];
        }
        console.log(jilu_type + ":" + page_stat_tag[jilu_type]);
        jilu_list_pub();
        return false;
    });

    $(".page_list_box").on("click", "a", function () {
        //page_num = $(this).text();
        page_num = $(this).text();
        page_cur_num = $(".page_list_box li.current a").text();
        if (page_num == "下一页") {

            page_num = parseInt(page_cur_num) + 1;
        }
        if (page_num == "上一页") {
            page_num = parseInt(page_cur_num) - 1;
        }
        page_stat_tag[jilu_type] = page_num;
//        call_ajax_url = $(this).attr("href");
        console.log(page_num);
        console.log(call_ajax_url);
        //刷新主数据区
        reCallMainData();
        return false;
    });

    function jilu_list_pub() {
        console.log(jilu_type);
        jilu_ajax_url = call_ajax_url + "?p=" + page_num;
        $.ajax({
            url: jilu_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                p: page_num,
                jilu_type: jilu_type,
                area_id: area_id,
                area_type: area_type
            },
            success: function (data, testStatus) {
                //alert(data);
                $("#xiaofei_table_list tbody").html("");
                i = 0;
                while (data[i]) {
                    //alert(data[i].uid);
                    ins_html_tr = "<tr><td>"
                            + data[i].uid + "</td><td>"
                            + data[i].platform + "</td><td>"
                            + data[i].fmoney + "</td><td>"
                            + moment(parseInt(data[i].addtime), "X").format("YYYY-MM-DD HH:mm:ss") + "</td><td>"
                            + data[i].realname + "</td><td>"
                            + showNull(data[i].beizhu) + "</td></tr>";
                    $("#xiaofei_table_list tbody").append(ins_html_tr);
                    i++;
                }
                $(".page_list_box ul").html(data.page_show);
            },
            error: function () {
                alert("文章列表加载失败");
            },
            dataType: "json"
        });
    }


    /*   ------------------------  充值及余额  ----------------------    */
// 标签内容页切换
    var index_i;
    $(".multipage_menu li").click(function () {
        $(this).addClass("current").siblings().removeClass("current");
        index_i = $(".multipage_menu li").index(this);
        $(".multipage_body > li").eq(index_i).show().siblings().hide();

        $(this).addClass("current").siblings().removeClass("current");
        jilu_type = $(this).children().attr("rel");

        return false;
    });
   // $(".multipage_menu li").eq(0).click();

    /*
     function chongzhi_list_pub() {
     console.log(jilu_type);
     $.ajax({
     url: "jsondata/jilu.json.js",
     type: "GET",
     timeout: 300000,
     global: true,
     cache: false,
     data: {
     ajax: 1,
     p: page_num
     },
     success: function (data, testStatus) {
     //alert(data);
     $("#xiaofei_table_list tbody").html();
     i = 0;
     while (data[i]) {
     //alert(data[i].uid);
     ins_html_tr = "<tr><td>"
     + data[i].uid + "</td><td>"
     + data[i].platform + "</td><td>"
     + data[i].fmoney + "</td><td>"
     + data[i].addtime + "</td><td>"
     + data[i].realname + "</td><td>"
     + data[i].beizhu + "</td></tr>";
     $("#xiaofei_table_list tbody").append(ins_html_tr);
     i++;
     }
     $(".page_list_box ul").html(data.page_show);
     },
     error: function () {
     alert("加载失败");
     },
     dataType: "json"
     });
     }
     */

//加载主页面后自动执行的动作
    //$("#xaiofei_button_list>li").eq(0).click();
    $("#load_start_click").click();

    /* 刷新主数据区操作 */
    function reCallMainData() {
        if ($("#xiaofei_table_list").length > 0) {
            jilu_list_pub();
        }
    }

    /* ------------------- 省市县菜单联动  --------------------
     * 
     *   提交给服务器的地区行政等级用name属性
     *   操作的id属性比name多一个后缀“_id”，以避免id命名冲突
     *   */
    var area_ajax_url;
    var son_area_type = "province";
    var area_select_box = "#" + son_area_type + "_id";
    area_ajax_url = $("#area_ajax_url").attr("href");

    $("#regionalism_select_box select").change(function () {
        area_id = $(this).children('option:selected').val();
        area_type = $(this).attr("name");
        son_area_type = $(this).next().attr("name");
        // 清空下级地区原选项
        // 特殊地区设置，如全国、直辖市
        // 全国：默认为0
        if (area_id == 0) {
            son_area_type = area_type;
            area_type = "quan";
        }
        area_select_box = "#" + son_area_type + "_id";
        console.log(area_id + "," + son_area_type);
        area_list_pub();
        //刷新数据区数据
        reCallMainData();

    });

    area_list_pub();

    function area_list_pub() {
        // 先清空原选项，再插入一个空选项
        cur_area_id = "#" + area_type + "_id";
        if (area_type == "quan") {
            cur_area_id = "#province_id";
        }
        $(cur_area_id).nextAll().each(function () {
            $(this).html("");
            console.log("已清空：" + $(this).attr("name"));
        });
        $(cur_area_id).next().html("<option value=\"\">⬇</option>");
        $.ajax({
            url: area_ajax_url,
            type: "POST",
            timeout: 300000,
            global: true,
            cache: false,
            data: {
                ajax: 1,
                area_id: area_id,
                area_type: area_type
            },
            success: function (data, testStatus) {
                //alert(data[1].id);
                i = 0;
                while (data[i]) {
                    //alert(data[i].uid);
                    ins_html_op = "<option value=\""
                            + data[i].id + "\">"
                            + data[i].realname + "</option>\n";
                    $(area_select_box).append(ins_html_op);
                    i++;
//                    console.log(ins_html_op);
                }
            },
            error: function () {
                alert("地区列表加载失败");
            },
            dataType: "json"
        });

    }



    /* 时间设置与运算  */
    $("#button_day").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date);
        start_date = moment().subtract(1, "days").format("YYYY-MM-DD");
        $("#start_date").val(start_date);
    });
    $("#button_day").click();
    $("#button_week").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date);
        start_date = moment().subtract(7, "days").format("YYYY-MM-DD");
        $("#start_date").val(start_date);
    });
    $("#button_month").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date);
        start_date = moment().subtract(1, "months").format("YYYY-MM-DD");
        $("#start_date").val(start_date);
    });
    $("#button_trimester").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date);
        start_date = moment().subtract(3, "months").format("YYYY-MM-DD");
        $("#start_date").val(start_date);
    });
    $("#button_halfyear").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date);
        start_date = moment().subtract(6, "months").format("YYYY-MM-DD");
        $("#start_date").val(start_date);
    });
    $("#button_year").click(function () {
        end_date = moment().format("YYYY-MM-DD");
        $("#end_date").val(end_date);
        start_date = moment().subtract(1, "years").format("YYYY-MM-DD");
        $("#start_date").val(start_date);
    });
});

/* -------------------------------------------------------------------- 
 * 浏览器不支持DATE类型调用相关插件
 * */

var i = document.createElement('input');
i.setAttribute('type', 'date');
//浏览器不支持date类型
if (i.type == 'text') {
    console.log("浏览器不支持DATE输入控件");

}



/*  一些值的处理函数  */
function showNull(bl) {
    if (bl == undefined) {
        return "";
    }
}