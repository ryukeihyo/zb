<?php
// +----------------------------------------------------------------------
// | CoreThink [ Simple Efficient Excellent ]
// +----------------------------------------------------------------------
// | Copyright (c) 2014 http://www.corethink.cn All rights reserved.
// +----------------------------------------------------------------------
// | Author: liujb
// +----------------------------------------------------------------------
namespace Admin\Controller;
use Think\Controller;
use Think\Model;

/**
 * 收入统计控制器
 * @author liujb
 */
class IncomeStatisticsController extends AdminController
{

    /**
     * 收入统计
     * author liujb
     *
     */
    public function index(){

       // $this->settlementRecords('2017-06-01 12:18:54','2017-06-16 12:18:54');
       // $this->selectIncome('1','quan','0');
        if($_POST['ajax']) {
            $money_type = $_POST['money_type'];
            $area_id   = $_POST['area_id'];
            $area_type = $_POST['area_type'];
            $p = $_GET['p']?$_GET['p']:1;

            $this->search_money($area_id,$area_type,$money_type,$p);

        }else{
            $this->display('');
        }

    }

    /**
     * 生成结算记录
     * @param $stardate  结算开始时间
     * @param $enddate   结算结束时间
     * author liujb 20160621
     */
    public function  settlementRecords($stardate,$enddate){

        /*$res = M('Xiaofei')->field('count(*) as cnt')
            ->where("addtime  BETWEEN UNIX_TIMESTAMP('$stardate') and UNIX_TIMESTAMP('$enddate') ")->select();*/
        $stardate = strtotime($stardate);
        $enddate  = strtotime($enddate);

        $map['addtime'] = array('between',array($stardate,$enddate));

        $res = M('Xiaofei')->field('count(*) as cnt')->where($map)->select();
        //echo  M('Xiaofei')->field('count(*) as cnt')->where($map)->getLastSql();
        $result = "";
        if($res[0]['cnt'] > 0 ){

            $data['settlement_start_date'] = $stardate;
            $data['settlement_end_date']   = $enddate;
            $result = D('Settlement_history')->add($data);
        }
        echo $result;

    }

    /**
     * 查询收入统计
     * @param $stardate
     * @param $enddate
     * author Fox
     */
    public function  selectIncome($date_id,$area_type,$area_id){
       $map_date['id'] = $date_id;
        $date = M('Settlement_history')->where($map_date)->select();
        //echo  M('Settlement_history')->where($map_date)->getLastSql();
      //  var_dump($date);
        if($area_type == 'quan'){
            $map_q['parentid'] = $area_id;
            $data_quan = D('User')->where($map_q)->select();
            //var_dump($data_quan);
            $model = new Model();
            $income_data ="";
            foreach($data_quan as $da ){
                $area_id = $da['id'];
                //直辖市查询
                if(($da['username'] == 'F110000') ||($da['username'] == 'F120000') || ($da['username'] == 'F310000') ||($da['username'] == 'F500000') ){
                    var_dump($area_id);
                    $data=$model->query("SELECT id FROM zb_user
                                  WHERE parentid IN ( SELECT id FROM zb_user
                                  WHERE parentid IN (SELECT id FROM zb_user
                                  WHERE parentid IN ($area_id)));
                                  ");
                     $income_data['jisuan_name'] = $da['realname'];
                     $income_data['jiesuan_bili'] = '';
                    //var_dump($data);
                }else{
                    //省份查询
                }
            }

    /*        //$model->query("SELECT id FROM zb_user WHERE parentid IN ( SELECT id FROM zb_user WHERE parentid IN (SELECT id FROM zb_user WHERE parentid IN ($area_id)));
");*/
    }

    }

    }