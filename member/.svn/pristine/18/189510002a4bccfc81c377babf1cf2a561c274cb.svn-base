<?php
// +----------------------------------------------------------------------
// | CoreThink [ Simple Efficient Excellent ]
// +----------------------------------------------------------------------
// | Copyright (c) 2014 http://www.corethink.cn All rights reserved.
// +----------------------------------------------------------------------
// | Author: liujb
// +----------------------------------------------------------------------
namespace Admin\Controller;
use Think\Controller;
/**
 * 消费记录控制器
 * @author liujb
 */
class ConsumptionRecordController extends AdminController
{

    /**
     * 消费记录
     * author liujb
     *
     */
    public function index(){


        if($_POST['ajax']) {
            $jilu_type = $_POST['jilu_type'];
            $area_id   = $_POST['area_id'];
            switch($jilu_type){
                case 'xiaofei':
                        break;
                case 'xianjin':
                        break;
                case 'zebaib':
                        break;
                case 'yucun11':
                        break;
                }
        }else{
            //默认
            $p = $_GET['p']?$_GET['p']:1;

            $record_list = D('Xiaofei as xf ')->field('SUM(fmoney) as fmoney,xf.username,xf.uid,u.platform,zbu.realname,xf.addtime')
                      ->join('zb_user u ON xf.payuid =u.id ')
                      ->join('zb_user zbu ON zbu.id = xf.uid')
                      ->group('xf.username,u.platform,xf.uid ')
                      ->having('SUM(fmoney)>0')
                      ->order('u.platform ,xf.uid DESC ')
                      ->page('$p,10')
                      ->select();

            $total = D('Xiaofei')->field('SUM(fmoney) as total')->select();

            $list = D('Xiaofei as xf ')->field('SUM(fmoney) as fmoney,xf.username,xf.uid,u.platform,zbu.realname')
                  ->join('zb_user u ON xf.payuid =u.id ')
                  ->join('zb_user zbu ON zbu.id = xf.uid')
                  ->group('xf.username,u.platform,xf.uid ')
                  ->having(' SUM(fmoney)>0')
                  ->select();

            $page = new \Common\Util\Page(count($list),10);// 实例化分页类 传入总记录数和每页显示的记录数

            $page_show       = $page->show();// 分页显示输出
            $record_list['total'] = $total[0]['total'];
            $record_list['page_show'] = $page_show;
           // var_dump($record_list);
            //echo D('Xiaofei')->field('SUM(fmoey) as total')->getLastSql();
            //$this->ajaxReturn($record_list,'JSON');
            $this->assign('record_list', $record_list);
            $this->display('');
        }
    }

    /**
     * 查询消费记录
     * author Fox
     */
    public function xiaofei($area_id,$area_type,$jilu_type){
        if($area_type == 'province'){
            //查询省下面所有市id
            $province_data = D('User')->field('id')->where('parentid = '.$area_id)->select();
            $province_str ='';
            foreach($province_data as $pro){
                $province_str .= "'".$pro['id']."',";
            }
            $province_str = rtrim($province_str,",");
            //查询市下面的所有县
            $city_data = D('User')->field('id')->where("parentid in ($province_str)")->select();
            //echo  D('User')->field('id')->where("parentid in ($province_str)")->getLastSql();
            $city_str = '';
            foreach($city_data as $ct){
                $city_str .= "'".$ct['id']."',";
            }
            $city_str = rtrim($city_str,",");
            //查询业务员id
            $yewuyuan_data = D('User')->field('id')->where("parentid in ($city_str)")->select();
            //echo  D('User')->field('id')->where("parentid in ($city_str)")->getLastSql();
            //查询业务员下面的商铺id
            $shop_data  = D('User')->field('id')->where("parentid in ($yewuyuan_data)")->select();
            //查询消费记录
            $map = '';
            switch($jilu_type){
                case 'xianjin':
                    $map['typeid'] = '1';
                    break;
                case 'yucun':
                    $map['typeid'] = '2';
                    break;
                case 'zebaib':
                    $map['typeid'] = '3';
                    break;
            }
            $map['parentid'] = array('in',$shop_data);
            $xiaofei_record =  D('Xiaofei as xf ')->field('SUM(fmoney) as fmoney,xf.username,xf.uid,u.platform,zbu.realname')
                ->join('zb_user u ON xf.payuid =u.id ')
                ->join('zb_user zbu ON zbu.id = xf.uid')
                ->group('xf.username,u.platform,xf.uid ')
                ->having('SUM(fmoney)>0')
                ->order('u.platform ,xf.uid DESC ')
                ->page('$p,10')
                ->select();
                echo D('Xiaofei as xf ')->field('SUM(fmoney) as fmoney,xf.username,xf.uid,u.platform,zbu.realname')
                    ->join('zb_user u ON xf.payuid =u.id ')
                    ->join('zb_user zbu ON zbu.id = xf.uid')
                    ->group('xf.username,u.platform,xf.uid ')
                    ->having('SUM(fmoney)>0')
                    ->order('u.platform ,xf.uid DESC ')
                    ->page('$p,10')->getLastSql();
        }else if($area_type == 'city'){

        }else if($area_type == 'county'){

        }else{

        }
    }



}

?>
