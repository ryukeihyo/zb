<?php
// +----------------------------------------------------------------------
// | CoreThink [ Simple Efficient Excellent ]
// +----------------------------------------------------------------------
// | Copyright (c) 2014 http://www.corethink.cn All rights reserved.
// +----------------------------------------------------------------------
// | Author: liujb
// +----------------------------------------------------------------------
namespace Admin\Controller;
use Think\Controller;
/**
 * 消费记录控制器
 * @author liujb
 */
class ConsumptionRecordController extends AdminController
{

    /**
     * 消费记录
     * author liujb
     *
     */
    public function index(){

echo "test";
        if($_POST['ajax']) {
                $jilu_type = $_POST['jilu_type'];
                $area_id   = $_POST['area_id'];
                switch($jilu_type){
                    case 'xiaofei':
                        break;
                    case 'xianjin':
                        break;
                    case 'zebaib':
                        break;
                    case 'yucun11':
                        break;
                }
        }else{
            //默认
            $p = $_GET['p']?$_GET['p']:1;

            $record_list = D('Xiaofei as xf ')->field('SUM(fmoney) as fmoney,xf.username,xf.uid,u.platform,zbu.realname')
                      ->join('zb_user u ON xf.payuid =u.id ')
                      ->join('zb_user zbu ON zbu.id = xf.uid')
                      ->group('xf.username,u.platform,xf.uid ')
                      ->having('SUM(fmoney)>0')
                      ->order('u.platform ,xf.uid DESC ')
                      ->page('$p,10')
                      ->select();

            $total = D('Xiaofei')->field('SUM(fmoney) as total')->select();

            $list = D('Xiaofei as xf ')->field('SUM(fmoney) as fmoney,xf.username,xf.uid,u.platform,zbu.realname')
                  ->join('zb_user u ON xf.payuid =u.id ')
                  ->join('zb_user zbu ON zbu.id = xf.uid')
                  ->group('xf.username,u.platform,xf.uid ')
                  ->having(' SUM(fmoney)>0')
                  ->select();

            $page = new \Common\Util\Page(count($list),10);// 实例化分页类 传入总记录数和每页显示的记录数

            $page_show       = $page->show();// 分页显示输出
            $record_list['total'] = $total[0]['total'];
            $record_list['page_show'] = $page_show;
            //echo D('Xiaofei')->field('SUM(fmoey) as total')->getLastSql();
            $this->ajaxReturn($record_list,'JSON');
        }
    }

    /**
     * 查询消费几率
     * author Fox
     */
    public function xiaofei($area_id,$area_type,$jilu_type){
        if($area_type == 'province'){
            $province_data = D('User')->field('id')->where('parentid = '.$area_id)->select();
            $province_str ='';
            foreach($province_data as $pro){
                $province_str .= "'".$pro['id']."',";
            }
            $province_str = rtrim($province_str,",");
            $city_data = D('User')->field('id')->where("parentid in ($province_str)")->select();
            //echo  D('User')->field('id')->where("parentid in ($province_str)")->getLastSql();
            $city_str = '';
            foreach($city_data as $ct){
                $city_str .= "'".$ct['id']."',";
            }
            $city_str = rtrim($city_str,",");
            $yewuyuan_data = D('User')->field('id')->where("parentid in ($city_str)")->select();
            echo  D('User')->field('id')->where("parentid in ($city_str)")->getLastSql();
            var_dump($yewuyuan_data);
        }else if($area_type == 'city'){

        }else if($area_type == 'county'){

        }else{

        }
    }



}

?>
